import uuid
from astrbot.api.event import filter, AstrMessageEvent, MessageEventResult
from astrbot.api.star import Context, Star, register
from astrbot.api.message_components import *
from .comfyui_api import ComfyUI
from astrbot.api import llm_tool, logger
from .oss import upload_public_file
import random


# è·å–å½“å‰æ–‡ä»¶çš„ç»å¯¹è·¯å¾„
current_file_path = os.path.abspath(__file__)
# è·å–å½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„ç»å¯¹è·¯å¾„
current_directory = os.path.dirname(current_file_path)
# å›¾ç‰‡ç”Ÿæˆå­˜æ”¾ç›®å½•
img_path = os.path.join(current_directory, 'output', 'temp.png')


@register("astrbot_plugin_comfyui", "guilty", "è°ƒç”¨ComfyUI æœåŠ¡è¿›è¡Œæ–‡ç”Ÿå›¾", "1.0.0",
          "https://github.com/GUILTYxC/astrbot_plugin_comfyui")
class ComfyUIPlugin(Star):
    def __init__(self, context: Context, config: dict):
        super().__init__(context)
        client_id = str(uuid.uuid4())
        try:
            self.comfy_ui = ComfyUI(config, client_id)
        except Exception:
            logger.error(f"ã€åˆå§‹åŒ– ComfyUI Websocket å®¢æˆ·ç«¯å¤±è´¥ï¼Œè¯·æ³¨æ„æ˜¯å¦å·²å¼€å¯ ComfyUI æœåŠ¡ç«¯ã€‘")

    # async def initialize(self):
    #     self.context.activate_llm_tool("comfyui_txt2img")

    # @llm_tool(name="comfyui_txt2img")
    @filter.command("draw",alias={'çº¦ç¨¿'})   
    async def comfyui_txt2img(self, event: AstrMessageEvent, prompt: str) -> MessageEventResult:
        '''AI painting based on the prompts entered by the user.

        Args:
            prompt(string): A prompt for text to image,if the user inputs Chinese prompts, they need to be translated into English prompts that are closely aligned with the specialized terms used for AI painting, such as the prompts used when creating AI art with Midjourney.
            img_width(number): The width of the image generated by AI painting. Optional parameter, this does not need to be parsed when there is no specified information about the image width.
            img_height(number): The height of the image generated by AI painting. Optional parameter, this does not need to be parsed when there is no specified information about the image height.
        '''
        user_name = event.get_sender_name()
        CUTE_MESSAGES = [
            "æ”¶åˆ°å•¦ï½{user_name}ç¨ç­‰ç‰‡åˆ»ï¼Œå°‘å¥³æ­£åœ¨åŠªåŠ›ç”»ç”»ä¸­...ğŸ¨",
            "{user_name}åˆ«ç€æ€¥å“¦ï½æˆ‘è¿™å°±å»ç”»ç»™ä½ çœ‹ï¼âœ¨",
            "å“‡å‘œï½æ”¶åˆ°ä½ çš„è¯·æ±‚å•¦ï¼é©¬ä¸Šä¸ºä½ ç»˜åˆ¶ä¸€å¹…ç¾ç¾çš„ç”»ï½ğŸ–Œï¸",
            "{user_name}æƒ³è¦ä»€ä¹ˆé£æ ¼çš„ç”»å‘¢ï¼Ÿè®©æˆ‘çŒœçŒœ...å…ˆå‡†å¤‡ç”»å¸ƒå•¦ï½ğŸ“˜",
            "å“¼ï½åˆæ¥è®©æˆ‘ç”»ç”»ï¼Œå¥½å§...æœ¬å°å§å‹‰ä¸ºå…¶éš¾åœ°æ¥ä¸‹è¿™ä¸ªä»»åŠ¡ï¼",
            "è¿™ç§å°äº‹ä¸ç”¨ä½ æé†’å•¦ï¼æˆ‘æ—©å°±å‡†å¤‡å¥½ç”»å¸ƒäº†ï¼",
            "çœŸæ˜¯çš„...æ¯æ¬¡éƒ½æ‰¾æˆ‘å¸®å¿™ï¼Œä¹Ÿä¸è¯´å£°è¯·ï¼Œè¯·æˆ‘å–æ¯å¥¶èŒ¶å†ç»§ç»­ï¼",
            "ä½ ä»¥ä¸ºç”»å›¾å¾ˆå®¹æ˜“å—ï¼Ÿç»™ç‚¹æ—¶é—´å•¦ï¼Œåˆ«å‚¬äº†ï¼",
            "è™½ç„¶å¾ˆéº»çƒ¦ï¼Œä¸è¿‡...çœ‹åœ¨æ˜¯ä½ çš„ä»½ä¸Šå°±ç ´ä¾‹ä¸€æ¬¡å¥½äº†ã€‚",
            "å•Šå•Šå•Šå¥½çƒ¦å“¦ï¼çŸ¥é“äº†çŸ¥é“äº†ï½é©¬ä¸Šç»™ä½ ç”»å°±æ˜¯äº†ï¼"
        ]
        safe = event.get_message_str().startswith("çº¦ç¨¿")
        prompt = event.get_message_str().replace("draw", "", 1)
        # åŒæ—¶å»é™¤â€œçº¦ç¨¿â€ï¼Œç»™qqç”¨
        prompt = prompt.replace("çº¦ç¨¿", "", 1)
        prompt += ',masterpiece, best quality, highly detailed'
        # å¦‚æœæ˜¯qqæ¸ é“,æ­£å‘æç¤ºè¯å¢åŠ å®‰å…¨è¯
        if event.get_message_str().startswith("çº¦ç¨¿"):
            prompt = 'General, ' + prompt
        logger.info(f"prompt:{prompt}")
        message = random.choice(CUTE_MESSAGES).format(user_name=user_name)
        yield event.plain_result(message)
    
        if safe:
            img = self.comfy_ui.text_2_img(prompt, None,None,True)
        else:
            img = self.comfy_ui.text_2_img(prompt, None,None,False)
        # å°†å›¾ç‰‡ä¿å­˜åˆ°å½“å‰outputç›®å½•ä¸‹
        with open(img_path, 'wb') as fp:
            fp.write(img)
        logger.info("å°†å›¾ç‰‡ä¸Šä¼ åˆ°oss")
        uuid_name = uuid.uuid4().hex
        upload_public_file(file_path=img_path,
            bucket_name="image",
            object_name="ai/" + uuid_name + ".png",
            endpoint_url="http://123.56.117.196:9000",  # ç”¨ä½ çš„æœåŠ¡å™¨ IP æ›¿æ¢
            access_key="admin",
            secret_key="admin123456")
        file_url = "http://123.56.117.196:9000/image/ai/" + uuid_name + ".png"
        chain = [
            # Image.fromURL(file_url)
            Image.fromFileSystem(img_path)
        ]
        logger.info(f"å°†å›¾ç‰‡{file_url}å‘é€ç»™ç”¨æˆ·...")
        yield event.chain_result(chain)
        logger.info(f"å›¾ç‰‡{file_url}å‘é€æˆåŠŸï¼")
